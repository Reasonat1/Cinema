<?php
function my_backend_init() {
    drupal_add_css(drupal_get_path('module', 'my_backend') . '/include/my_backend.css');
    /**
     * External files link
     */
    drupal_add_css('//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css', array('type' => 'external'));
	if(!path_is_admin(current_path())) {
	  drupal_add_css('https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css', array('type' => 'external'));
	}
    
}

/*
 * custom block info
 */
function my_backend_block_info() {

  $blocks = array();

  $blocks['festival_menu_block'] = array(
    'info' => t('festival menu'), 
  );

  return $blocks;
}

/*
 * custom block view
 */
function my_backend_block_view($delta = '') {

    $block = array();

    switch ($delta) {

    case 'festival_menu_block': 
        $block['subject'] = '';
        $block['content'] =custom_festival_menu_block_content();
        break;

    }

  return $block;
}

/*
 * custom block view callback
 */
function custom_festival_menu_block_content(){
	global $_domain;
	if($_domain['domain_id'] == 1) {
		return ;
	}
	
	$term_tid = db_query("SELECT `entity_id` FROM `field_data_field_cm_domain` WHERE `field_cm_domain_value` = :did",array(':did' => $_domain['domain_id']))->fetchField();
    
    $output = "";
    $term_page = arg(0);
    if($term = taxonomy_term_load($term_tid)) {
		$menu = $term->cinematic_menu;
		// texonomy accssociated menu
		if($menu != ''){
		   $menu_source =$menu.'_links_source';
		   $menu_depth = 2;
		  $menu_load =  menu_load($menu);
		  $menu_load_name =$menu_load['title'];
		  $output = menu_tree_output(menu_tree_all_data($menu, null, $menu_depth));
		}
    }
    return $output;
}

/**
 * Implements hook_form_alter().
 */
function my_backend_form_alter(&$form, &$form_state, $form_id) {
  $button_title= isset($form['actions']['submit']['#value']) ? $form['actions']['submit']['#value'] :'send';
  switch($form_id) {
    case 'webform_client_form_19':
       $form['actions']['submit'] = array(
        '#type' => 'submit',
        '#value' => $button_title,
        '#ajax' => array(
          'callback' => 'custom_webform_news_letter_form_js_submit',
          'wrapper' => 'webform-client-form-' . $form['#node']->nid,
          'effect' => 'fade',
        ),
        '#id' => 'edit-submit--' . $form['#node']->nid,
      );
      break;
  }
}

function custom_webform_news_letter_form_js_submit($form, &$form_state){
  $sid = $form_state['values']['details']['sid'];
   return $form;
}

function my_backend_search_api_query_alter(SearchApiQueryInterface $query) {
  global $user;
  $mySearchid=$query->getOption('search id');
  $query->setOption('search id', $mySearchid.':custom_search');
  $results=$query->execute();
  $query->setOption('search id', $mySearchid);
  
  foreach ($results['results'] as $n_id=>$value) {
	  
	  $myNode=node_load($n_id);
	 if ($myNode->type=='cm_movie') $movieArray[$n_id]=$myNode->title;
	 if ($myNode->type=='cm_event') $eventArray[$n_id]=$myNode->title;  
	}
  foreach ($eventArray as $del_id=>$del_title) {
	  if (in_array($del_title, $movieArray)) $query->condition('nid', $del_id, '<>');
  }
}

